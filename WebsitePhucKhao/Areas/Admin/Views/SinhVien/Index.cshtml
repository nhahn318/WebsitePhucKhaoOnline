@model IEnumerable<WebsitePhucKhao.Models.SinhVien>

@{
    ViewData["Title"] = "Quản lý sinh viên";
}

<!-- Page Header -->
<div class="admin-page-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">Quản lý sinh viên</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Dashboard", new { area = "Admin" })">Bảng điều khiển</a></li>
                    <li class="breadcrumb-item active">Sinh viên</li>
                </ol>
            </nav>
        </div>
        <button class="btn btn-primary btn-create" data-bs-toggle="modal" data-bs-target="#formModal">
            <i class="fas fa-plus me-2"></i>Thêm sinh viên
        </button>
    </div>
</div>

<!-- Search & Filter Section -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Tìm kiếm</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control table-search" name="searchTerm" value="@ViewBag.SearchTerm" placeholder="Nhập từ khóa...">
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label">Khoa</label>
                <select class="form-select" name="khoa">
                    <option value="">Tất cả</option>
                    @foreach (var khoa in ViewBag.Khoas ?? new List<string>())
                    {
                        <option value="@khoa" selected="@(ViewBag.SelectedKhoa == khoa)">@khoa</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Lớp</label>
                <select class="form-select" name="lop">
                    <option value="">Tất cả</option>
                    @foreach (var lop in ViewBag.Lops ?? new List<string>())
                    {
                        <option value="@lop" selected="@(ViewBag.SelectedLop == lop)">@lop</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-filter me-2"></i>Lọc
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Main Content -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th data-sortable>Mã SV</th>
                        <th data-sortable>Họ tên</th>
                        <th data-sortable>Email</th>
                        <th data-sortable>Số điện thoại</th>
                        <th data-sortable>Khoa</th>
                        <th data-sortable>Chuyên ngành</th>
                        <th data-sortable>Lớp</th>
                        <th class="text-center">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>@item.MaSinhVien</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle me-2" style="width: 32px; height: 32px; font-size: 1rem;">
                                        <i class="fas fa-user-graduate"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold">@item.HoTen</div>
                                        <div class="text-muted small">@item.Email</div>
                                    </div>
                                </div>
                            </td>
                            <td>@item.Email</td>
                            <td>@item.SoDienThoai</td>
                            <td>@item.Khoa</td>
                            <td>@item.ChuyenNganh</td>
                            <td>@item.Lop</td>
                            <td class="text-center">
                                <button class="btn btn-action btn-view" data-bs-toggle="tooltip" title="Xem chi tiết">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-action btn-edit" data-id="@item.MaSinhVien" data-bs-toggle="tooltip" title="Chỉnh sửa">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-action btn-delete" data-id="@item.MaSinhVien" data-bs-toggle="tooltip" title="Xóa">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Form Modal -->
<div class="modal fade" id="formModal" tabindex="-1" aria-labelledby="formModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="formModalLabel">Thêm sinh viên</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="studentForm" method="post" data-validate>
                    <div class="mb-3">
                        <label class="form-label">Mã sinh viên</label>
                        <input type="text" class="form-control" name="MaSinhVien" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Họ tên</label>
                        <input type="text" class="form-control" name="HoTen" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="Email" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Số điện thoại</label>
                        <input type="tel" class="form-control" name="SoDienThoai" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Khoa</label>
                        <select class="form-select" name="Khoa" required>
                            <option value="">Chọn khoa</option>
                            @foreach (var khoa in ViewBag.Khoas ?? new List<string>())
                            {
                                <option value="@khoa">@khoa</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Chuyên ngành</label>
                        <input type="text" class="form-control" name="ChuyenNganh" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Lớp</label>
                        <select class="form-select" name="Lop" required>
                            <option value="">Chọn lớp</option>
                            @foreach (var lop in ViewBag.Lops ?? new List<string>())
                            {
                                <option value="@lop">@lop</option>
                            }
                        </select>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Form Submit Handler
            $('#studentForm').on('submit', function(e) {
                e.preventDefault();
                const formData = $(this).serialize();
                $.post('@Url.Action("Create")', formData)
                    .done(function() {
                        $('#formModal').modal('hide');
                        location.reload();
                    })
                    .fail(function(xhr) {
                        alert('Có lỗi xảy ra: ' + xhr.responseText);
                    });
            });

            // Edit Button Handler
            $('.btn-edit').on('click', function() {
                const id = $(this).data('id');
                $.get('@Url.Action("GetById")/' + id)
                    .done(function(data) {
                        $('#formModalLabel').text('Chỉnh sửa sinh viên');
                        $('#studentForm').attr('action', '@Url.Action("Update")/' + id);
                        Object.keys(data).forEach(key => {
                            $(`#studentForm [name="${key}"]`).val(data[key]);
                        });
                        $('#formModal').modal('show');
                    })
                    .fail(function(xhr) {
                        alert('Có lỗi xảy ra: ' + xhr.responseText);
                    });
            });

            // Delete Button Handler
            $('.btn-delete').on('click', function() {
                if (confirm('Bạn có chắc chắn muốn xóa sinh viên này?')) {
                    const id = $(this).data('id');
                    $.post('@Url.Action("Delete")/' + id)
                        .done(function() {
                            location.reload();
                        })
                        .fail(function(xhr) {
                            alert('Có lỗi xảy ra: ' + xhr.responseText);
                        });
                }
            });

            // View Button Handler
            $('.btn-view').on('click', function() {
                const maSinhVien = $(this).closest('tr').find('.btn-edit').data('id');
                window.location.href = '@Url.Action("Details")/' + maSinhVien;
            });

            // Create Button Handler
            $('.btn-create').on('click', function() {
                $('#formModalLabel').text('Thêm sinh viên');
                $('#studentForm').attr('action', '@Url.Action("Create")');
                $('#studentForm')[0].reset();
            });

            // Initialize Tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Table Search
            $('.table-search').on('keyup', function() {
                const searchText = $(this).val().toLowerCase();
                $('table tbody tr').each(function() {
                    const rowText = $(this).text().toLowerCase();
                    $(this).toggle(rowText.includes(searchText));
                });
            });

            // Table Sort
            $('th[data-sortable]').on('click', function() {
                const table = $(this).closest('table');
                const tbody = table.find('tbody');
                const rows = tbody.find('tr').toArray();
                const index = $(this).index();
                const isAsc = $(this).hasClass('asc');

                rows.sort((a, b) => {
                    const aValue = $(a).children('td').eq(index).text().trim();
                    const bValue = $(b).children('td').eq(index).text().trim();
                    return isAsc ? 
                        bValue.localeCompare(aValue) : 
                        aValue.localeCompare(bValue);
                });

                $(this).toggleClass('asc');
                tbody.empty().append(rows);
            });
        });
    </script>
}
